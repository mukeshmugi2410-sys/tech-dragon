{% extends "base.html" %}
{% block title %}My Payslips{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-money-check-alt me-2"></i>My Payslips</h2>
    <div class="btn-group">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#payslipHelpModal">
            <i class="fas fa-question-circle me-1"></i>Help
        </button>
        <button class="btn btn-primary" id="downloadAll">
            <i class="fas fa-download me-1"></i>Download All
        </button>
    </div>
</div>

<!-- Payslip Summary -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <i class="fas fa-wallet fa-3x mb-3 text-primary"></i>
            <h2>₹{{ current_salary or 0 }}</h2>
            <p>Current Salary</p>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card" style="border-bottom-color: var(--success-color);">
            <i class="fas fa-calendar-alt fa-3x mb-3 text-success"></i>
            <h2>{{ slips|length }}</h2>
            <p>Total Payslips</p>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card" style="border-bottom-color: var(--warning-color);">
            <i class="fas fa-chart-line fa-3x mb-3 text-warning"></i>
            <h2>₹{{ total_earned or 0 }}</h2>
            <p>Total Earned</p>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card" style="border-bottom-color: var(--info-color);">
            <i class="fas fa-tasks fa-3x mb-3 text-info"></i>
            <h2>{{ pending_slips or 0 }}</h2>
            <p>Pending</p>
        </div>
    </div>
</div>

<!-- Payslip Filter -->
<div class="dashboard-card mb-4">
    <div class="row">
        <div class="col-md-4 mb-3">
            <select class="form-select" id="yearFilter">
                <option value="">All Years</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            <select class="form-select" id="monthFilter">
                <option value="">All Months</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="Paid">Paid</option>
                <option value="Pending">Pending</option>
                <option value="Processing">Processing</option>
            </select>
        </div>
    </div>
</div>

<!-- Payslips List -->
<div class="row">
    {% for p in slips %}
    <div class="col-md-6 mb-4">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h5 class="mb-1">Payslip for {{ p.month_year }}</h5>
                    <p class="text-muted mb-0">Payment Date: {{ p.payment_date or 'Not specified' }}</p>
                </div>
                <span class="badge bg-success">Paid</span>
            </div>

            <div class="row mb-3">
                <div class="col-6">
                    <p class="mb-1"><strong>Basic Salary:</strong></p>
                    <h4 class="text-primary">₹{{ p.basic }}</h4>
                </div>
                <div class="col-6">
                    <p class="mb-1"><strong>Net Salary:</strong></p>
                    <h4 class="text-success">₹{{ p.net }}</h4>
                </div>
            </div>

            <div class="mb-3">
                <p class="mb-1"><strong>Bank Account:</strong> {{ p.bank_account or 'Not specified' }}</p>
                <p class="mb-0"><strong>Payment Method:</strong> {{ p.payment_method or 'Bank Transfer' }}</p>
            </div>

            <div class="btn-group w-100">
                <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewPayslipModal{{ p.id }}">
                    <i class="fas fa-eye me-1"></i>View Details
                </button>
                <button class="btn btn-sm btn-success">
                    <i class="fas fa-download me-1"></i>Download PDF
                </button>
                <button class="btn btn-sm btn-primary">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not slips %}
<div class="dashboard-card text-center py-5">
    <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
    <h4>No Payslips Available</h4>
    <p class="text-muted">Your payslips will appear here once processed.</p>
</div>
{% endif %}

<script>
    // Filter functionality
    document.getElementById('yearFilter').addEventListener('change', filterPayslips);
    document.getElementById('monthFilter').addEventListener('change', filterPayslips);
    document.getElementById('statusFilter').addEventListener('change', filterPayslips);

    function filterPayslips() {
        const yearFilter = document.getElementById('yearFilter').value;
        const monthFilter = document.getElementById('monthFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        const payslipCards = document.querySelectorAll('.col-md-6.mb-4');

        payslipCards.forEach(card => {
            const monthYear = card.querySelector('h5').textContent;
            const status = card.querySelector('.badge').textContent;

            let show = true;

            if (yearFilter && !monthYear.includes(yearFilter)) {
                show = false;
            }

            if (monthFilter) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[parseInt(monthFilter) - 1];
                if (!monthYear.includes(monthName)) {
                    show = false;
                }
            }

            if (statusFilter && !status.includes(statusFilter)) {
                show = false;
            }

            card.style.display = show ? 'block' : 'none';
        });
    }
</script>
{% endblock %}

{% block modals %}
<!-- Help Modal -->
<div class="modal fade" id="payslipHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payslip Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Understanding Your Payslip:</h6>
                <ul>
                    <li><strong>Basic Salary:</strong> Your fixed monthly salary</li>
                    <li><strong>Gross Salary:</strong> Basic + Allowances</li>
                    <li><strong>Net Salary:</strong> Gross - Deductions</li>
                    <li><strong>Deductions:</strong> Taxes, PF, insurance, etc.</li>
                </ul>

                <h6 class="mt-3">Common Questions:</h6>
                <div class="accordion" id="payslipFAQ">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#faq1">
                                When are payslips generated?
                            </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#payslipFAQ">
                            <div class="accordion-body">
                                Payslips are generated on the last working day of each month.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#faq2">
                                How to download payslip?
                            </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#payslipFAQ">
                            <div class="accordion-body">
                                Click the "Download PDF" button on any payslip card.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="/support" class="btn btn-primary">Contact Support</a>
            </div>
        </div>
    </div>
</div>

{% for p in slips %}
<!-- View Payslip Modal -->
<div class="modal fade" id="viewPayslipModal{{ p.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payslip Details - {{ p.month_year }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Payslip Design -->
                <div class="payslip-container border rounded p-4">
                    <div class="text-center mb-4">
                        <h4 class="mb-1">ABC Company Pvt. Ltd.</h4>
                        <p class="text-muted mb-0">Salary Payslip for {{ p.month_year }}</p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Employee Name:</strong> {{ p.name }}</p>
                            <p><strong>Employee ID:</strong> {{ p.employee_id }}</p>
                            <p><strong>Position:</strong> {{ p.position }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Payment Date:</strong> {{ p.payment_date }}</p>
                            <p><strong>Bank Account:</strong> {{ p.bank_account }}</p>
                            <p><strong>Status:</strong> <span class="badge bg-success">Paid</span></p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <strong>Earnings</strong>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Basic Salary:</span>
                                        <span>₹{{ p.basic }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>House Rent Allowance:</span>
                                        <span>₹{{ p.hra or '0' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Travel Allowance:</span>
                                        <span>₹{{ p.ta or '0' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Medical Allowance:</span>
                                        <span>₹{{ p.medical or '0' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Overtime Pay:</span>
                                        <span>₹{{ p.overtime or '0' }}</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>Total Earnings:</strong>
                                        <strong>₹{{ p.gross or p.basic }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-danger text-white">
                                    <strong>Deductions</strong>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Provident Fund:</span>
                                        <span>₹{{ p.pf or '0' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Professional Tax:</span>
                                        <span>₹{{ p.ptax or '0' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Income Tax:</span>
                                        <span>₹{{ p.tax or '0' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Insurance:</span>
                                        <span>₹{{ p.insurance or '0' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Loan Deduction:</span>
                                        <span>₹{{ p.loan or '0' }}</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>Total Deductions:</strong>
                                        <strong>₹{{ p.deductions or '0' }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h3 class="mb-0 text-success">
                                Net Salary: ₹{{ p.net }}
                            </h3>
                            <p class="text-muted mb-0">(In words: {{ p.net_in_words or 'Rupees' }})</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary">
                    <i class="fas fa-download me-1"></i>Download PDF
                </button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}